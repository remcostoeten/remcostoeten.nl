#!/usr/bin/env bash

# Get terminal dimensions
TERM_HEIGHT=$(tput lines 2>/dev/null || echo 24)
TERM_WIDTH=$(tput cols 2>/dev/null || echo 80)

# ANSI color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# Terminal control sequences
HIDE_CURSOR='\033[?25l'
SHOW_CURSOR='\033[?25h'

# Banner height (number of lines)
BANNER_HEIGHT=8

function generate_separator() {
  local width=$1
  local separator=""
  local i=0
  while [ $i -lt $width ]; do
    separator="${separator}‚îÅ"
    i=$((i + 1))
  done
  echo "$separator"
}

function print_banner() {
  local width=$1
  local separator=$(generate_separator $width)
  
  # Save cursor and move to top
  echo -ne "\033[s\033[1;1H"
  
  echo -e "${CYAN}${BOLD}${separator}${NC}"
  echo -e "${BOLD}${BLUE}                    ‚ö†Ô∏è  PRODUCTION BUILD REMINDER ‚ö†Ô∏è${NC}"
  echo -e "${CYAN}${BOLD}${separator}${NC}"
  echo ""
  echo -e "${YELLOW}${BOLD}üìã IMPORTANT:${NC} Before deploying to production, ensure your .env file contains:"
  echo ""
  echo -e "  ${BOLD}${CYAN}GOOGLE_SITE_VERIFICATION${NC}${YELLOW}=your_verification_code${NC}"
  echo -e "  ${BOLD}${CYAN}YANDEX_VERIFICATION${NC}${YELLOW}=your_verification_code${NC}"
  echo -e "${CYAN}${BOLD}${separator}${NC}"
  
  # Restore cursor
  echo -ne "\033[u"
}

function cleanup_on_exit() {
  echo -ne "${SHOW_CURSOR}"
}

trap cleanup_on_exit EXIT

# Hide cursor
echo -ne "${HIDE_CURSOR}"

# Print initial banner
print_banner $TERM_WIDTH

# Add spacing after banner
echo ""

# Sleep for 250 milliseconds
sleep 0.25

# Print build start message
echo -e "${BLUE}${BOLD}üî® Starting build process...${NC}"
echo ""

# Run the build with output in real-time, filtering out fish shell noise
# Temporarily disable pipefail to capture the actual build status
set +o pipefail
bun next build 2>&1 | sed -u -E 's/@fish \([0-9-]+\)//g; s/^[[:space:]]*@[^[:space:]]+[[:space:]]*//g; s/\(fish[^)]*\)//g'
BUILD_STATUS=${PIPESTATUS[0]}
set -o pipefail

# After build completes, print result
echo ""

if [ $BUILD_STATUS -ne 0 ]; then
  separator=$(generate_separator $TERM_WIDTH)
  echo -e "${RED}${BOLD}${separator}${NC}"
  echo -e "${RED}${BOLD}‚ùå Build has failed${NC}"
  echo -e "${RED}${BOLD}${separator}${NC}"
  echo ""
  
  echo -ne "${SHOW_CURSOR}"
  exit 1
else
  separator=$(generate_separator $TERM_WIDTH)
  echo -e "${GREEN}${BOLD}${separator}${NC}"
  echo -e "${GREEN}${BOLD}‚úÖ Build completed successfully!${NC}"
  echo -e "${GREEN}${BOLD}${separator}${NC}"
  echo ""
  echo -e "${CYAN}Run ${BOLD}bun start${NC}${CYAN} to view the build version.${NC}"
  echo ""
  
  echo -ne "${SHOW_CURSOR}"
  exit 0
fi
